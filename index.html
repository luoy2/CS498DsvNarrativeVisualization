<!DOCTYPE html>
<html>
<head>
    <script src='https://d3js.org/d3.v5.min.js'></script>
    <style>

        .chart {
            background: #fff;
            margin: 5px;
        }
    </style>
</head>

<body onload='init()'>
<svg class="chart" width="960" height="500"
     viewBox="0 0 960 500"
     preserveAspectRatio="xMidYMid meet"></svg>

<script>
    var date_parser = d3.utcParse("%Y-%m-%d %H:%M:%S")
    const cellSize = 15
    const yearHeight = cellSize * 7 + 25
    const formatDay = d => ["Mo", "Tu", "We", "Th", "Fr", "Sa", "Su"][d.getUTCDay()]
    const countDay = d => d.getUTCDay()
    const timeWeek = d3.utcSunday
    const svg = d3.selectAll("svg")
    var data = []
    var legend = svg.append('g')
    var rect = svg.selectAll("rect")
    var months = {}
    var years = {}

    async function init() {

        data = await d3.csv("data/timesheet.csv");
        data.forEach(function (d) {
            d.date = d3.utcParse("%Y-%m-%d")(d.date);
            d.start_time = date_parser(d.start_time);
            d.end_time = date_parser(d.end_time);
            d.minutes = parseFloat(d.minutes);
        });
        console.log(data);

        years = d3.nest()
            .key(d => d.start_time.getUTCFullYear())
            .entries(data)
            .reverse()
        console.log(years);

        months = d3.nest()
            .key(d => [d.start_time.getUTCFullYear(), d.start_time.getUTCMonth()])
            .entries(data)
            .reverse()
        console.log(months);


        var year = d3.select("svg").append("g")
            .data(years)
            .attr('transform', (d, i) => `translate(40, ${yearHeight * i + cellSize * 1.5})`);

        year.append('text')
            .attr('x', -5)
            .attr('y', -30)
            .attr("text-anchor", "end")
            .attr('font-size', 16)
            .attr('font-weight', 550)
            .attr('transform', 'rotate(270)')
            .text(d => d.key);

        year.append('g')
            .attr('text-anchor', 'end')
            .selectAll('text')
            .data(d3.range(7).map(i => new Date(1999, 0, i)))
            .join('text')
            .attr('x', -5)
            .attr('y', d => (countDay(d) + 0.5) * cellSize)
            .attr('dy', '0.31em')
            .text(formatDay);

        year.append('g')
            .selectAll('rect')
            .data(d => d.values)
            .join('rect')
            .attr("width", cellSize - 1.5)
            .attr("height", cellSize - 1.5)
            .attr("x", (d, i) => timeWeek.count(d3.utcYear(d.date), d.date) * cellSize + 10)
            .attr("y", d => countDay(d.date) * cellSize + 0.5)
            .attr("fill", d => colorScale(d.minutes));

        let div = d3.select("body").append("div")
            .attr("class", "tooltip-donut")
            .style("opacity", 0);

        svg.selectAll('rect').on('mouseover', function (d, i) {
            d3.select(this).transition()
                .duration('50')
                .attr('opacity', '.85');
            //Makes the new div appear on hover:
            div.transition()
                .duration(50)
                .style("opacity", 1);
        })
            .on('mouseout', function (d, i) {
                d3.select(this).transition()
                    .duration('50')
                    .attr('opacity', '1');
                //Makes the new div disappear:
                div.transition()
                    .duration('50')
                    .style("opacity", 0);
            });

    }

    const colorScale = d3.scaleSequential()
        .interpolator(d3.interpolateBuGn)
        .domain([0, 720]);


</script>
</body>
</html>